

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>Jsonrpc — PHPEGG</title>
    <meta charset="utf-8">
    <meta name="description" content="Vue.js - The Progressive JavaScript Framework">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'> -->
    <!-- <link href='//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js' rel='stylesheet' type='text/css'> -->

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>
    <script>window.PAGE_TYPE = "doc"</script>

  </head>
  <body class="docs">    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <span>PHPEGG</span>
  </a>
  <ul id="nav">
    

<li><a href="https://github.com/qiu-jin/phpegg" target="_blank" class="nav-link contribute">Github</a></li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      

<li><a href="https://github.com/qiu-jin/phpegg" target="_blank" class="nav-link contribute">Github</a></li>

    </ul>
    <div class="list">
        <ul class="menu-root">
          
            
            
              
                <li><h3>开始</h3></li>
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/index.html" class="sidebar-link">介绍</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/installation.html" class="sidebar-link">安装</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/structure.html" class="sidebar-link">目录结构</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/quickstart.html" class="sidebar-link">开始应用</a>
              </li>
            
           
          
            
            
              
              
                <li><h3>应用</h3></li>
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app.html" class="sidebar-link">综述</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-standard.html" class="sidebar-link">标准</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-rest.html" class="sidebar-link">Rest</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-micro.html" class="sidebar-link">微应用</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-inline.html" class="sidebar-link">inline</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-jsonrpc.html" class="sidebar-link current">Jsonrpc</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-grpc.html" class="sidebar-link">Grpc</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/app-custom.html" class="sidebar-link">自定义</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="#" class="sidebar-link">无模式（暂空）</a>
              </li>
            
           
          
            
            
              
              
              
                <li><h3>核心</h3></li>
              
              
              
              
              
            
            
              <li>
                <a href="/doc/config.html" class="sidebar-link">配置</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/loader.html" class="sidebar-link">类加载</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="#" class="sidebar-link">容器（暂空）</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/hook.html" class="sidebar-link">事件</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="#" class="sidebar-link">验证器（暂空）</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/router.html" class="sidebar-link">路由</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/error.html" class="sidebar-link">错误处理</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/logger.html" class="sidebar-link">日志</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/view.html" class="sidebar-link">视图</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="#" class="sidebar-link">模版（暂空）</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/function.html" class="sidebar-link">辅助函数</a>
              </li>
            
           
          
            
            
              
              
              
              
                <li><h3>HTTP层</h3></li>
              
              
              
              
            
            
              <li>
                <a href="/doc/http-request.html" class="sidebar-link">请求</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/http-response.html" class="sidebar-link">响应</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/http-client.html" class="sidebar-link">Client</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/http-cookie-session.html" class="sidebar-link">Cookie & Session</a>
              </li>
            
           
          
            
            
              
              
              
              
              
                <li><h3>数据库</h3></li>
              
              
              
            
            
              <li>
                <a href="/doc/db.html" class="sidebar-link">基本使用</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/db-query.html" class="sidebar-link">数据操作</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/db-join-query.html" class="sidebar-link">连表查询</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/db-sample.html" class="sidebar-link">示例表</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
                <li><h3>驱动</h3></li>
              
              
            
            
              <li>
                <a href="/doc/driver-cache.html" class="sidebar-link">缓存</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/driver-storage.html" class="sidebar-link">存储</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/driver-rpc.html" class="sidebar-link">RPC</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/driver-email.html" class="sidebar-link">邮件</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/driver-sms.html" class="sidebar-link">短信</a>
              </li>
            
           
          
            
            
              
              
              
              
              
              
              
            
            
              <li>
                <a href="/doc/driver-other.html" class="sidebar-link">其它驱动</a>
              </li>
            
           
          
        </ul>
    </div>
  </div>
</div>


<div class="content doc with-sidebar app-jsonrpc-doc">

  
    <h1>Jsonrpc</h1>
  
  <h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><p>jsonrpc模式参考<a href="http://www.jsonrpc.org/specification" target="_blank" rel="external">jsonrpc2.0</a>协议实现（阅读本章节请先熟悉jsonrpc2.0），基本遵守协议，但部分地方有点出入（不同点会在文档中说明）。</p>
<h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment">//app/demo/public/index_jsonrpc.php</span></div><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="string">'../../../framework/app.php'</span>;</div><div class="line"></div><div class="line">framework\App::start(<span class="string">'Jsonrpc'</span>, [</div><div class="line">    <span class="string">'batch_max_num'</span> =&gt; <span class="number">1000</span>,</div><div class="line">])-&gt;run();</div></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight php"><table><tr><td class="code"><pre><div class="line">[</div><div class="line">    <span class="comment">// 控制器namespace</span></div><div class="line">    <span class="string">'controller_ns'</span> =&gt; <span class="string">'controller'</span>,</div><div class="line">    <span class="comment">// 控制器类名后缀</span></div><div class="line">    <span class="string">'controller_suffix'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">    <span class="comment">/* 参数模式</span></div><div class="line"><span class="comment">     * 0 无参数</span></div><div class="line"><span class="comment">     * 1 顺序参数</span></div><div class="line"><span class="comment">     * 2 键值参数</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="string">'param_mode'</span>    =&gt; <span class="number">1</span>,</div><div class="line">    <span class="comment">// 最大批调用数，1不启用批调用，0无限批调用数</span></div><div class="line">    <span class="string">'batch_max_num'</span> =&gt; <span class="number">1</span>,</div><div class="line">    <span class="comment">// 批调用异常中断</span></div><div class="line">    <span class="string">'batch_exception_abort'</span> =&gt; <span class="keyword">false</span>,</div><div class="line">    <span class="comment">/* 通知调用模式</span></div><div class="line"><span class="comment">     * false, 不使用通知调用</span></div><div class="line"><span class="comment">     * true，使用Hook close实现伪后台任务</span></div><div class="line"><span class="comment">     * string，使用异步队列任务实现，string为队列任务名</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="string">'notification_mode'</span> =&gt; <span class="keyword">false</span>,</div><div class="line">    <span class="comment">// 通知回调方法</span></div><div class="line">    <span class="string">'notification_callback'</span> =&gt; <span class="keyword">null</span>,</div><div class="line">    </div><div class="line">    <span class="comment">// Request 解码, 也支持igbinary_unserialize msgpack_unserialize等</span></div><div class="line">    <span class="string">'request_unserialize'</span> =&gt; <span class="string">'jsondecode'</span>,</div><div class="line">    <span class="comment">// Response 编码, 也支持igbinary_serialize msgpack_serialize等</span></div><div class="line">    <span class="string">'response_serialize'</span> =&gt; <span class="string">'jsonencode'</span>,</div><div class="line">    <span class="comment">// Response content type header</span></div><div class="line">    <span class="string">'response_content_type'</span> =&gt; <span class="keyword">null</span></div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><p>jsonrpc模式是以jsonrpc请求数据中的<code>method</code>来调度，以符号<code>.</code>分割<code>method</code>成多个单元，从0到倒数第2个之间的单元匹配控制器类，最后一个单元匹配控制器方法。</p>
<blockquote>
<p>如<code>&quot;method&quot;: &quot;foo.Bar.baz&quot;</code> 会调用<code>app\controller\foo\Bar::baz()</code></p>
</blockquote>
<p><code>controller_ns</code>与<code>controller_suffix</code>配置说明参考<a href="standard.html">standard模式</a></p>
<p><code>request_unserialize</code>（默认为<code>jsondecode</code>）与<code>response_serialize</code>（默认为<code>jsonencode</code>）配置，用来处理请求数据的反序列化和响应数据序列化，虽然jsonrpc2.0协议规定使用json来编解码请求和响应，但是为了提高编解码效率和减少传输数据大小，我们还可以igbinary msgpack等协议来编解码请求和响应（需要安装对应扩展）。</p>
<p>如需设置特定<code>content_type</code>响应header头，可使用<code>response_content_type</code>配置（默认为空）</p>
<p>jsonrpc模式支持单控制器方法调用和批量调用，其由<code>batch_max_num</code>配置控制（默认为1），为1时不支持批量调用，为0时支持无上限的批量调用，为大于1的整数时控制器方法调用次数不能大于<code>batch_max_num</code>（对外提供接口时，如需开启批量调用，请设置一个合适的<code>batch_max_num</code>值防止cc攻击）。</p>
<blockquote>
<p>注意：在本jsonrpc模式实现中，批量调用是按序进行，响应结果也是按序排列，而不是协议中说的任意顺序和任意宽度。</p>
</blockquote>
<p><code>batch_exception_abort</code>配置（默认为<code>false</code>），决定当批量调用时某个控制器方法调用触发异常时是否继续剩余的方法调用，为true时为继续调用，为<code>false</code>时为终止调用，并以<code>&#39;error&#39; =&gt; [&#39;code&#39;=&gt; -32002, &#39;message&#39; =&gt; &#39;Batch request abort&#39;]</code>填充剩余的方法的<code>return</code>。</p>
<blockquote>
<p>注意：即使<code>batch_exception_abort</code>设为<code>false</code>，调用<code>App::abort()</code>方法也会终止批量调用。</p>
</blockquote>
<p><code>notification_mode</code>配置（默认为<code>false</code>），按照jsonrpc2.0协议，当请求的<code>id</code>为空时，此请求为一个通知请求，通知请求不需要立即将请求结果返回，所以服务端可以将通知请求任务放在后台运行，并提前关闭请求链接。</p>
<p>当<code>notification_mode</code>为<code>false</code>时不启用通知请求，仍按照正常请求处理。</p>
<p>当<code>notification_mode</code>为<code>true</code>，会提前使用<code>fastcgi_finish_request</code>关闭请求链接，再执行请求任务。</p>
<p>当<code>notification_mode</code>为<code>string</code>，使用异步队列任务实现，<code>string</code>为队列任务名（功能尚未实现）</p>
<blockquote>
<p>注意：通知请求会返回<code>null</code>，而不是按协议中什么都不返回，另外当批调用中有通知请求时，也会在批调用结果中插入<code>null</code>，而不是什么都没有。</p>
</blockquote>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p><code>param_mode</code>支持3种参数模式（默认值为1）</p>
<p>1 无参数模式</p>
<p>控制器方法不需要任何参数，不过处理器仍然会解析参数，并将<code>params</code>参数绑定到<code>Request post</code>，使用时可以用<code>Resquset::post()</code>方法获取。</p>
<p>2 顺序list参数模式</p>
<p>将<code>params</code>通过list参数模式传给控制器方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>, <span class="string">"method"</span>: <span class="string">"User.getNames"</span>, <span class="string">"params"</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], <span class="string">"id"</span>: <span class="number">1</span>&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>如上请求，会调度<code>app\controller\User::getNames(1, 2, 3, 4)</code></p>
</blockquote>
<p>3 键值kv参数模式</p>
<p>将<code>params</code>通过kv键值对参数模式传给控制器方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>, <span class="string">"method"</span>: <span class="string">"User.getName"</span>, <span class="string">"params"</span>: &#123;<span class="string">"id"</span>:<span class="number">1</span>&#125;, <span class="string">"id"</span>: <span class="number">2</span>&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>如上请求，会调度<code>app\controller\User::getName(1)</code></p>
</blockquote>

  
    <div class="guide-links">
      
        <span>← <a href="/doc/app-inline.html">inline</a></span>
      
      
        <span style="float: right;"><a href="/doc/app-grpc.html">Grpc</a> →</span>
      
    </div>
  
  <div class="footer">
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- fastclick -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
