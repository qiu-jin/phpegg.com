

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>连表查询 — PHPEGG</title>
    <meta charset="utf-8">
    <meta name="description" content="Vue.js - The Progressive JavaScript Framework">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'> -->
    <!-- <link href='//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js' rel='stylesheet' type='text/css'> -->

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>
    <script>window.PAGE_TYPE = "doc"</script>

  </head>
  <body class="docs">    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <span>PHPEGG</span>
  </a>
  <ul id="nav">
    

<li><a href="https://github.com/qiu-jin/phpegg" target="_blank" class="nav-link contribute">Github</a></li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      

<li><a href="https://github.com/qiu-jin/phpegg" target="_blank" class="nav-link contribute">Github</a></li>

    </ul>
    <div class="list">
        <ul class="menu-root">
          
            
            
              
                <li><h3>开始</h3></li>
              
              
              
              
              
              
            
            <li>
              <a href="/doc/index.html" class="sidebar-link">介绍</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/installation.html" class="sidebar-link">安装</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/structure.html" class="sidebar-link">目录结构</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/quickstart.html" class="sidebar-link">开始应用</a>
            </li>
          
            
            
              
              
                <li><h3>应用</h3></li>
              
              
              
              
              
            
            <li>
              <a href="/doc/app.html" class="sidebar-link">综述</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-standard.html" class="sidebar-link">标准</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-rest.html" class="sidebar-link">Rest</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-micro.html" class="sidebar-link">微应用</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-inline.html" class="sidebar-link">inline</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-jsonrpc.html" class="sidebar-link">Jsonrpc</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-grpc.html" class="sidebar-link">Grpc</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/app-custom.html" class="sidebar-link">自定义</a>
            </li>
          
            
            
              
              
              
                <li><h3>核心</h3></li>
              
              
              
              
            
            <li>
              <a href="/doc/config.html" class="sidebar-link">配置</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/loader.html" class="sidebar-link">类加载</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/container.html" class="sidebar-link">容器</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/hook.html" class="sidebar-link">事件</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/validator.html" class="sidebar-link">验证器</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/router.html" class="sidebar-link">路由</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/error.html" class="sidebar-link">错误处理</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/logger.html" class="sidebar-link">日志</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/view.html" class="sidebar-link">视图</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/template.html" class="sidebar-link">模版</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/function.html" class="sidebar-link">辅助函数</a>
            </li>
          
            
            
              
              
              
              
                <li><h3>数据库</h3></li>
              
              
              
            
            <li>
              <a href="/doc/db.html" class="sidebar-link">基本使用</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/db-query.html" class="sidebar-link">数据操作</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/db-join-query.html" class="sidebar-link current">连表查询</a>
            </li>
          
            
            
              
              
              
              
              
                <li><h3>驱动</h3></li>
              
              
            
            <li>
              <a href="/doc/driver-cache.html" class="sidebar-link">缓存</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/driver-storage.html" class="sidebar-link">存储</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/driver-rpc.html" class="sidebar-link">RPC</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/driver-email.html" class="sidebar-link">邮件</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/driver-sms.html" class="sidebar-link">短信</a>
            </li>
          
            
            
              
              
              
              
              
              
            
            <li>
              <a href="/doc/driver-other.html" class="sidebar-link">其它</a>
            </li>
          
        </ul>
    </div>
  </div>
</div>


<div class="content doc with-sidebar db-join-query-doc">

  
    <h1>连表查询</h1>
  
  <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>使用联表查询可以用简单易懂的语法写出功能强大的联表操作，支持一对一，多对一，一对多，多对多等多种数据表关联，并且自动优化生成的SQL，既提高开发效率又提升代码运行效率。</p>
<blockquote>
<p>联表查询类似于<code>ActiveRecord</code>型<code>ORM</code>中的<code>hasOne hasMany belongsTo belongsToMany</code>等设定，相对<code>ORM</code>优点是不用生成大量对象，也不用写<code>model</code>模型代码定义每个表和表之间关系。</p>
</blockquote>
<p>写一个简单的例子，如一个在线社区论坛有多个主题贴子，每一个主题也有多个回复评论，如果我一次想要查询自己所有的主题贴子和所有的主题贴子的回复评论回复怎么办？ </p>
<ul>
<li>用常规写法，先查询所有的主题贴，再循环查询每个主题贴的回复评论 </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$posts = $db-&gt;post-&gt;where(<span class="string">'name'</span>, <span class="string">'qiujin'</span>)-&gt;find(); </div><div class="line"><span class="keyword">foreach</span> ($posts <span class="keyword">as</span> $i =&gt; $post) &#123; </div><div class="line">    $posts[$i][<span class="string">'post'</span>] = db-&gt;comment-&gt;where(<span class="string">'post_id'</span>, $post[<span class="string">'id'</span>])-&gt;find(); </div><div class="line">&#125; </div><div class="line"><span class="keyword">return</span> $posts;</div></pre></td></tr></table></figure>
<ul>
<li>使用<code>with</code>语句一行代码即可。 </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="keyword">return</span> $db-&gt;post-&gt;where(<span class="string">'name'</span>, <span class="string">'qiujin'</span>)-&gt;with(<span class="string">'comment'</span>)-&gt;find();</div></pre></td></tr></table></figure>
<p>对比就可以知道常规写法不仅啰嗦，而且低效，因为常规写法执行了<code>1+N</code>次<code>SQL</code>。 </p>
<p>而<code>with</code>语句简洁明了，查询 <code>post</code> 数据后，在把 <code>post</code> 数据中的 <code>id</code> 抽出组成 <code>where in</code> 查询 <code>comment</code> 表数据，最后把 <code>comment</code> 数据组合分配给 <code>post</code> 返回，其中只执行了 <code>1+1</code> 次 <code>SQL</code>，比常规写法效率高很多。</p>
<h2 id="Join方法"><a href="#Join方法" class="headerlink" title="Join方法"></a>Join方法</h2><p>生成原生SQL <code>JOIN</code>语句连表查询多表数据.</p>
<p>通常用一对一和多对一表关系场合</p>
<p>一对一：查询用户信息与其帐号积分信息（一个用户只有一个积分帐号表）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;join(<span class="string">'account'</span>)-&gt;select(<span class="string">'score'</span>)-&gt;get($user_id);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SELECT `user`.*,`account`.`score` AS `account_score` FROM `user` LEFT JOIN `account` ON `user`.`id` = `account`.`user_id` WHERE `user`.`id` = &apos;1&apos;</div></pre></td></tr></table></figure>
<p>多对一：查询最近10个主题以及发布者信息（一个用户可以发布多个主题）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;post-&gt;order(<span class="string">'id'</span>, <span class="keyword">true</span>)-&gt;limit(<span class="number">10</span>)-&gt;join(<span class="string">'user'</span>)-&gt;on(<span class="string">'user_id'</span>, <span class="string">'id'</span>)-&gt;select(<span class="string">'id'</span>, <span class="string">'name'</span>)-&gt;find();</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SELECT `post`.*,`user`.`id` AS `user_id`,`user`.`name` AS `user_name` FROM `post` LEFT JOIN `user` ON `post`.`user_id` = `user`.`id` ORDER BY `post`.`id` DESC LIMIT 10</div></pre></td></tr></table></figure>
<p><code>join</code>方法有3个参数</p>
<blockquote>
<p>第1个参数是要<code>join</code>的表名</p>
<p>第2个参数是<code>join</code>类型（支持<code>INNER</code> <code>LEFT</code> <code>RIGHT</code>，默认为<code>LEFT</code>）</p>
<p>第3个参数是表的别名（默认为空）</p>
</blockquote>
<p>从属<code>on</code>方法，用于指定主表与从表的关联字段，在符合默认设定的情况下无需使用。</p>
<blockquote>
<p>on方法有2个参数，第1个参数是主表的关联字段，第2个参数是从表的关联字段</p>
</blockquote>
<p>另外<code>join</code>支持<code>select(false)</code>写法，用于设置对应作用域的表不返回任何字段查询结果（不设置则返回所有字段查询结果）</p>
<h2 id="With方法"><a href="#With方法" class="headerlink" title="With方法"></a>With方法</h2><p>使用逻辑联表查询多表数据。</p>
<p>通常用于一对多和多对多表关系场合</p>
<p>在默认优化条件下只需要<code>1+1</code>次SQL查询，先查主表数据，然后根据主表数据<code>where in</code>查询从表数据，最后逻辑组合2表数据。</p>
<p>例：查询一个用户及其最近10个主题</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;with(<span class="string">'post'</span>)-&gt;order(<span class="string">'id'</span>, <span class="keyword">true</span>)-&gt;limit(<span class="number">10</span>)-&gt;get($user_id)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SELECT * FROM `user` WHERE `id` = &apos;1&apos; LIMIT 1</div><div class="line">SELECT * FROM `post` WHERE `user_id` = &apos;1&apos; ORDER BY `id` DESC LIMIT 10</div></pre></td></tr></table></figure>
<p>例：查询主题以及回复评论第1页</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;post-&gt;with(<span class="string">'comment'</span>)-&gt;page(<span class="number">1</span>)-&gt;get($post_id)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SELECT * FROM `post` WHERE `id` = &apos;1&apos; LIMIT 1</div><div class="line">SELECT * FROM `comment` WHERE `post_id` = &apos;1&apos; LIMIT 0,30</div></pre></td></tr></table></figure>
<p><code>with</code>方法有2个参数</p>
<blockquote>
<p>第1个参数是表名</p>
<p>第2个参数是表的别名（默认为空）</p>
</blockquote>
<p>从属<code>on</code>方法，用于指定主表与从表的关联字段，在符合默认设定的情况下无需使用。</p>
<blockquote>
<p>on方法有2个参数，第1个参数是主表的关联字段，第2个参数是从表的关联字段</p>
</blockquote>
<h2 id="relate方法"><a href="#relate方法" class="headerlink" title="relate方法"></a>relate方法</h2><p>通常用于多对多表关系场合，并且有一个关系表存储2个表的对应关系。</p>
<p>在默认优化条件下只需要<code>1+1+1</code>次SQL查询，先查主表数据，在查关系表数据，然后根据关系表数据查询从表数据，最后逻辑组合3表数据。</p>
<p>例：查询一个用户及其最近收藏书签的主题，其中<code>bookmark</code>书签表是关系表保存<code>user</code>和<code>post</code>多对多的映射关系。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;relate(<span class="string">'post'</span>)-&gt;on(<span class="string">'bookmark'</span>)-&gt;get($user_id);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SELECT * FROM `user` WHERE `id` = &apos;1&apos; LIMIT 1</div><div class="line">SELECT `user_id`, `post_id` FROM `bookmark` WHERE `user_id` IN (&apos;1&apos;)</div><div class="line">SELECT * FROM `post` WHERE `id` IN (&apos;2&apos;,&apos;3&apos;,&apos;5&apos;)</div></pre></td></tr></table></figure>
<p><code>relate</code>方法有2个参数</p>
<blockquote>
<p>第1个参数是表名</p>
<p>第2个参数是表的别名（默认为空）</p>
</blockquote>
<p>从属<code>on</code>方法，用于指定主表与从表的关系表与关联字段，在符合默认设定的情况下无需使用。</p>
<blockquote>
<p>on方法有3个参数，</p>
<p>第1个参数是主表和从表的关系表的表名，</p>
<p>第2个参数是主表与关系表的关联字段数组</p>
<p>第3个参数是从表与关系表的关联字段数组</p>
</blockquote>
<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><p>生成原生SQL子查询语句联表查询主表数据。</p>
<p>子查询通常只做为主表的过滤条件，用户不需要其本身数据。</p>
<p>例：查询最新一个主题的作者的信息。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;sub(<span class="string">'post'</span>)-&gt;order(<span class="string">'id'</span>, ture)-&gt;get()</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">SELECT * FROM `user` WHERE `id` IN (SELECT `user_id` FROM `post` ORDER BY `id` DESC)  LIMIT 1</div></pre></td></tr></table></figure>
<p>子查询<code>sub</code>方法有3个参数，后2个参数为可选参数。</p>
<blockquote>
<p>第1个参数是子查询表名</p>
<p>第2个参数是子查询做为查询条件并入主表的where表达式（默认为<code>IN</code>），参数集合<code>[&#39;=&#39;, &#39;&gt;&#39;, &#39;&lt;&#39;, &#39;&gt;=&#39;, &#39;&lt;=&#39;, &#39;&lt;&gt;&#39;, &#39;ANY&#39;, &#39;IN&#39;, &#39;SOME&#39;, &#39;ALL&#39;, &#39;EXISTS&#39;]</code></p>
<p>第2个参数是子查询做为查询条件并入主表的where逻辑组合默认为<code>AND</code>），参数集合<code>[&#39;AND&#39;, &#39;OR&#39;, &#39;XOR&#39;, &#39;AND NOT&#39;, &#39;OR NOT&#39;, &#39;NOT&#39;]</code></p>
</blockquote>
<p>从属<code>on</code>方法，用于指定主表与从表的关联字段，在符合默认设定的情况下无需使用。</p>
<blockquote>
<p>on方法有2个参数，第1个参数是主表的关联字段，第2个参数是从表的关联字段</p>
</blockquote>
<p>另外子查询除了支持<code>get</code> <code>find</code>等查询操作，也支持<code>update</code>更新操作和<code>delete</code>删除操作。</p>
<h2 id="union方法"><a href="#union方法" class="headerlink" title="union方法"></a>union方法</h2><p>使用原生SQL <code>union</code>语法联表查询主表数据。</p>
<p><code>union</code>用于表结构相同的多个表。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;table1-&gt;union(<span class="string">'table2'</span>)-&gt;union(<span class="string">'table3'</span>)-&gt;find()</div></pre></td></tr></table></figure>
<p><code>union</code> 方法较简单，支持一个参数指定<code>union</code>的表名，也没有从属<code>on</code>方法，并且只支持<code>find</code>查询方法。</p>
<h2 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h2><p>作用域的存在避免了在联表查询的链式方法中显式的申明表名，使联表查询语句简洁易懂。</p>
<p>在作用域内<code>where</code> <code>select</code> <code>order limit</code>等方法不需要显式的指定表名，因为作用域确定了这些方法是作用于那张表，并在生成SQL时自动处理。</p>
<p>示例：查找积分大于0的用户，及其在<code>2017-10-01</code>后发表的主题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;select(<span class="string">'id'</span>, <span class="string">'name'</span>)<span class="comment">// 查找用户id name</span></div><div class="line">   -&gt;sub(<span class="string">'account'</span>)-&gt;where(<span class="string">'score'</span>, <span class="string">'&gt;'</span>, <span class="number">0</span>)<span class="comment">// 查找用户积分score大于0的记录</span></div><div class="line">   -&gt;with(<span class="string">'post'</span>)-&gt;select(<span class="string">'id'</span>, <span class="string">'title'</span>)-&gt;where(<span class="string">'time'</span>, <span class="string">'&gt;'</span>, <span class="string">'2017-10-01'</span>) <span class="comment">//查找主表用户2017-10-01后发布主题的id和标题</span></div><div class="line">   -&gt;find(); /／执行查询</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// 生成并执行的SQL</div><div class="line">SELECT `id`,`name` FROM `user` WHERE `id` IN (SELECT `user_id` FROM `account` WHERE `score` &gt; &apos;0&apos;) </div><div class="line">SELECT `id`,`title`,`user_id` FROM `post` WHERE `user_id` IN (&apos;1&apos;,&apos;2&apos;,&apos;3&apos;,&apos;5&apos;) AND `time` &gt; &apos;2017-10-01&apos;</div></pre></td></tr></table></figure>
<p>下面解析下示例中的作用域</p>
<ol>
<li><p>主表<code>user</code>作用域，<code>$db-&gt;user</code>后就进入主表<code>user</code>的作用域，其后接方法<code>select(&#39;id&#39;, &#39;name&#39;)</code>是作用于主表<code>user</code>也就是查询主表的<code>id</code>与<code>name</code>，直到遇到连表方法才跳出主表作用域进入从表作用域。</p>
</li>
<li><p>子查询从表<code>account</code>作用域，<code>sub(&#39;account&#39;)</code>进入子查询从表<code>account</code>作用域，其后接方法<code>where(&#39;score&#39;, &#39;&gt;&#39;, 0)</code>作用于从表<code>account</code>，直到遇到其它连表方法才跳出其作用域进入其它从表作用域。</p>
</li>
<li><p><code>with</code>联表查询从表<code>post</code>作用域，<code>with(&#39;post&#39;)</code>进入<code>with</code>连表查询从表<code>post</code>作用域，<code>select(&#39;id&#39;, &#39;title&#39;)</code>和<code>where(&#39;time&#39;, &#39;&gt;&#39;, $time)</code>作用于从表<code>post</code>。</p>
</li>
<li><p>最后的查询方法<code>find</code>作用域为主表，连表查询最后查询方法<code>get</code> <code>find</code>等的作用域又跳回主表，其参数只作用于主表。。</p>
</li>
</ol>
<h2 id="关联字段"><a href="#关联字段" class="headerlink" title="关联字段"></a>关联字段</h2><p>当使用多个数据表进行联表查询时，表与表之间的关系时如何确定的，是通过什么字段将表关联起来的的呢？</p>
<p><strong><code>on</code>方法</strong></p>
<p>为了处理这个问题，每个联表方法都有自己特有从属<code>on</code>方法，此方法就是用来指定表之间的关联字段。</p>
<p>如例：查询一个主题贴及其发表者</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;with(<span class="string">'post'</span>)-&gt;on(<span class="string">'id'</span>, <span class="string">'user_id'</span>)-&gt;get($user_id)</div></pre></td></tr></table></figure>
<p>例中的post表和user表的关联字段就使用了<code>on</code>方法指定<code>user.id</code>关联<code>post.user_id</code>。</p>
<p><strong>默认关联</strong></p>
<p>默认关联规则为：主表的<code>id</code>字段默认关联从表中的<code>主表名＋id</code>的字段。</p>
<p>使用默认关联的规则，大部分情况下我们都无需使用<code>on</code>方法来指定关联字段，只要表与表之间符合默认关联的规则就可以省略<code>on</code>方法。</p>
<p>如上一个例子，我们也可以这样写。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;user-&gt;with(<span class="string">'post'</span>)-&gt;get($user_id)</div></pre></td></tr></table></figure>
<p>例中<code>-&gt;on(&#39;id&#39;, &#39;user_id&#39;)</code>被省略了，因为使用了默认关联规则：<code>user.id</code>默认关联<code>post.user_id</code>。</p>
<p>另外为了能方便使用默认关联，数据库字段名的设计最好符合以下2点。</p>
<blockquote>
<p>1 表主键名为<code>id</code></p>
<p>2 表外键名为<code>表名+id</code>，如<code>user_id</code>（建议表名为单数，不然用<code>users_id</code>挺别扭）</p>
</blockquote>
<h2 id="多重联表"><a href="#多重联表" class="headerlink" title="多重联表"></a>多重联表</h2><p>在大部分情况，我们只联2张表查询就基本满足大部分应用需求，但是有时候也可能有3张表及以上的联表查询需求。</p>
<p>联表查询3表及以上就叫做多重联表</p>
<p>多重联表示例：查询主题<code>1</code>及其发布者与评论信息</p>
<figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$db-&gt;post-&gt;join(<span class="string">'user'</span>)-&gt;on(<span class="string">'user_id'</span>, <span class="string">'id'</span>)-&gt;select(<span class="string">'name'</span>)-&gt;with(<span class="string">'comment'</span>)-&gt;get(<span class="number">1</span>)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// 生成并执行的SQL</div><div class="line">SELECT `post`.*,`user`.`name` AS `user_name` FROM `post` LEFT JOIN `user` ON `post`.`user_id` = `user`.`id` WHERE `post`.`id` = &apos;1&apos;</div><div class="line">SELECT * FROM `comment` WHERE `post_id` = &apos;1&apos;</div></pre></td></tr></table></figure>
<blockquote>
<p>例中关联到了<code>post</code> <code>user</code> <code>comment</code> 3个表，其中<code>post</code>作为主表，<code>user</code>是<code>join</code>从表，<code>comment</code>是<code>with</code>从表。</p>
<p><code>post</code>表与<code>user</code>表是多对一关系，一个<code>post</code>只有一个<code>user</code>发表者，一个<code>user</code>能发表多个<code>post</code>主题。</p>
<p><code>post</code>表与<code>comment</code>表是一对多关系，一个<code>post</code>有多条<code>comment</code>评论，一条<code>comment</code>只属于一个<code>post</code>主题。</p>
<p>先主表<code>post</code> <code>join</code> <code>user</code>表查询数据，表之间使用<code>on</code>方法关联字段，得到查询数据后使用<code>with</code>逻辑联表方法查询<code>omment</code>数据，表之间关联使用默认设定，然后组合数据返回。</p>
</blockquote>
<p></p><p class="tip"><br><code>join</code> <code>sub</code> <code>union</code>方法支持多重联表查询（但不支持混用）<br><br><br><code>join</code> <code>sub</code> <code>union</code>方法后也支持<code>with</code> <code>relate</code>方法<br></p><p></p>

  
    <div class="guide-links">
      
        <span>← <a href="/doc/db-query.html">数据操作</a></span>
      
      
    </div>
  
  <div class="footer">
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- fastclick -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
